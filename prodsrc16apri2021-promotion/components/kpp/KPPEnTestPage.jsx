import { Affix, Col, message, Row } from 'antd';
import axios from 'axios';
import _ from 'lodash';
import React, { useEffect, useState } from 'react';
import { Beforeunload } from 'react-beforeunload';
import { connect } from 'react-redux';
import { useMediaQuery } from 'react-responsive';
import client from '../../feathers';
import AnswerPaperForm from './answer-paper-form';
import QuestionList from './question-list';
import { updateActiveMenu } from '../../redux/actions/app-actions';
import { isValidNumber, notEmptyLength  } from '../../common-function';
import LayoutV2 from '../general/LayoutV2';


const Desktop = ({ children }) => {
    const isDesktop = useMediaQuery({ minWidth: 992 })
    return isDesktop ? children : null
  }
  const Tablet = ({ children }) => {
    const isTablet = useMediaQuery({ minWidth: 768, maxWidth: 991 })
    return isTablet ? children : null
  }
  const Mobile = ({ children }) => {
    const isMobile = useMediaQuery({ maxWidth: 767 })
    return isMobile ? children : null
  }
  const Default = ({ children }) => {
    const isNotMobile = useMediaQuery({ minWidth: 768 })
    return isNotMobile ? children : null
  }

const PAGE_SIZE = 50;

const KPPEN = (props) => {
    const [questions, setQuestions] = useState([])
    const [submitedQuestions, setSubmitedQuestions] = useState([])
    const [allAnswered, setAllAnswered] = useState(false);
    const [submited, setSubmited] = useState(false);
    const [visible, setVisible] = useState(false);



    useEffect(() => {
        getQuestions();
    }, [])

    useEffect(() => {

        if (notEmptyLength(questions)) {
            let allanswered = true;
            _.forEach(questions, function (question) {
                if (!question.selectedSelection._id) {
                    allanswered = false;
                    return false;
                }
            })
            setAllAnswered(allanswered);

        }

    }, [questions])

    const showDrawer = () => {
        visible == true ? setVisible(false) : setVisible(true)
    }

    const onClose = () => {
        visible == false ? setVisible(true) : setVisible(false)
    }

    const getQuestions = () => {
        props.updateActiveMenu('8');

        axios.get(`${client.io.io.uri}randomKppQuestions`, {
            params: {
                $match: {
                    language: 'EN',
                },
                $sort: {
                    weight: -1,
                    createdAt: -1,
                },
                limit: PAGE_SIZE,
            }
        }).then(res => {
            if (notEmptyLength(res.data.data)) {
                setQuestions(res.data.data.map(function (question) {
                    question.selectedSelection = {};
                    question.selections = _.shuffle(question.selections);
                    return question;
                }))
            } else {
                setQuestions([]);
            }
        }).catch(err => {
            message.error(err.message)
        });
    }

    return (
        <React.Fragment>
            <Beforeunload onBeforeunload={() => "You will be redirect to driving school main page. Are you sure?"} />
            <LayoutV2>
                <div className='section'>
                    <Desktop>
                    <div className="container">
                        <Row gutter={[10, 0]}>
                            <Col xs={24} sm={24} md={18} lg={18} xl={18}>
                                <div className='h5 black margin-bottom-sm'>
                                    KPP TEST
                                </div>
                                <div className='background-white padding-lg'>
                                    <QuestionList
                                        questions={notEmptyLength(questions) ? questions : []}
                                        itemClassName="margin-bottom-md box-shadow-thin round-border border-white"
                                        handleChange={(questions) => { setQuestions(questions) }}
                                        showCorrectAnswer={submited}
                                        answerAble={!submited} />
                                </div>
                            </Col>
                            <Col xs={0} sm={0} md={6} lg={6} xl={6}>
                                <Affix offsetTop={isValidNumber(props.app.menuHeight) ? parseInt(props.app.menuHeight) + 10 : 70} >
                                    <AnswerPaperForm
                                        questions={notEmptyLength(questions) ? questions : []}
                                        handleChange={(questions) => { setQuestions(questions) }}
                                        allAnswered={allAnswered}
                                        showCorrectAnswer={submited}
                                        answerAble={!submited}
                                        timer={1800000}
                                        handleSubmit={(questions) => { setSubmited(true); setSubmitedQuestions(questions) }} />
                                </Affix>
                            </Col>
                            <Col xs={24} sm={24} md={0} lg={0} xl={0}>
                                    <AnswerPaperForm
                                        questions={notEmptyLength(questions) ? questions : []}
                                        handleChange={(questions) => { setQuestions(questions) }}
                                        allAnswered={allAnswered}
                                        showCorrectAnswer={submited}
                                        answerAble={!submited}
                                        timer={1800000}
                                        handleSubmit={(questions) => { setSubmited(true); setSubmitedQuestions(questions) }} />
                            </Col>
                            {/* <div className="collapse-filter" style={{float:'right'}} >
                                <Affix offsetTop={200} onChange={affixed => {}}>
                                    <Button style={{position:'absolute'}} type="primary" onClick={() => showDrawer(true)}>
                                        <Icon type="caret-left" />
                                    </Button>
                                <Drawer
                                    placement="right"
                                    closable={true}
                                    onClose={() => setVisible(false)}
                                    visible={visible}
                                    width={350}
                                >
                                <div className="margin-top-sm">
                                <AnswerPaperForm
                                        questions={notEmptyLength(questions) ? questions : []}
                                        handleChange={(questions) => { setQuestions(questions) }}
                                        allAnswered={allAnswered}
                                        showCorrectAnswer={submited}
                                        answerAble={!submited}
                                        timer={1800000}
                                        handleSubmit={(questions) => { setSubmited(true); setSubmitedQuestions(questions) }} />
                                </div></Drawer>
                                </Affix>
                            </div> */}
                        </Row>
                    </div>
                    </Desktop>

                    <Tablet>
                    <div style={{paddingLeft:'10px', paddingRight:'10px'}}>
                        <Row gutter={[10, 0]}>
                            <Col xs={24} sm={24} md={15} lg={18} xl={18}>
                                <div className='h5 black margin-bottom-sm'>
                                    KPP TEST
                                </div>
                                <div className='background-white'>
                                    <QuestionList
                                        questions={notEmptyLength(questions) ? questions : []}
                                        itemClassName="margin-bottom-md box-shadow-thin round-border border-white"
                                        handleChange={(questions) => { setQuestions(questions) }}
                                        showCorrectAnswer={submited}
                                        answerAble={!submited} />
                                </div>
                            </Col>
                            <Col xs={0} sm={0} md={9} lg={6} xl={6}>
                                <Affix offsetTop={isValidNumber(props.app.menuHeight) ? parseInt(props.app.menuHeight) + 10 : 70} >
                                    <AnswerPaperForm
                                        questions={notEmptyLength(questions) ? questions : []}
                                        handleChange={(questions) => { setQuestions(questions) }}
                                        allAnswered={allAnswered}
                                        showCorrectAnswer={submited}
                                        answerAble={!submited}
                                        timer={1800000}
                                        handleSubmit={(questions) => { setSubmited(true); setSubmitedQuestions(questions) }} />
                                </Affix>
                            </Col>
                        </Row>
                    </div>

                    <Mobile>
                    <div className="container">
                        <Row gutter={[10, 0]}>
                            <Col xs={24} sm={24} md={18} lg={18} xl={18}>
                                <div className='h5 black margin-bottom-sm'>
                                    KPP TEST
                                </div>
                                <div className='background-white padding-lg'>
                                    <QuestionList
                                        questions={notEmptyLength(questions) ? questions : []}
                                        itemClassName="margin-bottom-md box-shadow-thin round-border border-white"
                                        handleChange={(questions) => { setQuestions(questions) }}
                                        showCorrectAnswer={submited}
                                        answerAble={!submited} />
                                </div>
                            </Col>
                            <Col xs={0} sm={0} md={6} lg={6} xl={6}>
                                <Affix offsetTop={isValidNumber(props.app.menuHeight) ? parseInt(props.app.menuHeight) + 10 : 70} >
                                    <AnswerPaperForm
                                        questions={notEmptyLength(questions) ? questions : []}
                                        handleChange={(questions) => { setQuestions(questions) }}
                                        allAnswered={allAnswered}
                                        showCorrectAnswer={submited}
                                        answerAble={!submited}
                                        timer={1800000}
                                        handleSubmit={(questions) => { setSubmited(true); setSubmitedQuestions(questions) }} />
                                </Affix>
                            </Col>
                            <Col xs={24} sm={24} md={0} lg={0} xl={0}>
                                    <AnswerPaperForm
                                        questions={notEmptyLength(questions) ? questions : []}
                                        handleChange={(questions) => { setQuestions(questions) }}
                                        allAnswered={allAnswered}
                                        showCorrectAnswer={submited}
                                        answerAble={!submited}
                                        timer={1800000}
                                        handleSubmit={(questions) => { setSubmited(true); setSubmitedQuestions(questions) }} />
                            </Col>
                            {/* <div className="collapse-filter" style={{float:'right'}} >
                                <Affix offsetTop={200} onChange={affixed => {}}>
                                    <Button style={{position:'absolute'}} type="primary" onClick={() => showDrawer(true)}>
                                        <Icon type="caret-left" />
                                    </Button>
                                <Drawer
                                    placement="right"
                                    closable={true}
                                    onClose={() => setVisible(false)}
                                    visible={visible}
                                    width={350}
                                >
                                <div className="margin-top-sm">
                                <AnswerPaperForm
                                        questions={notEmptyLength(questions) ? questions : []}
                                        handleChange={(questions) => { setQuestions(questions) }}
                                        allAnswered={allAnswered}
                                        showCorrectAnswer={submited}
                                        answerAble={!submited}
                                        timer={1800000}
                                        handleSubmit={(questions) => { setSubmited(true); setSubmitedQuestions(questions) }} />
                                </div></Drawer>
                                </Affix>
                            </div> */}
                        </Row>
                    </div>
                    </Mobile>

                    </Tablet>
                </div>
            </LayoutV2>
        </React.Fragment>
    )

}

const mapStateToProps = state => ({
    app: state.app,
});

const mapDispatchToProps = {
    updateActiveMenu: updateActiveMenu,
}

export default connect(mapStateToProps, mapDispatchToProps)(KPPEN);